<!DOCTYPE html>
<html lang="en" class="grid">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>the rendezvous at last</title>
    <link rel="icon" href="favicon.ico" />
    <link rel="stylesheet" type="text/css" href="./styles_shared.css" />
    <link rel="stylesheet" type="text/css" href="./styles_website.css" />
    <script src="./gameplay.js" defer></script>
    <style>
      body {
        /* this is just to make dev easier */
        /* border: 2px dotted yellow; */
        /* hardcoded scene size in increments of 50px */
        height: 800px;
        width: 3000px;
        overflow: hidden;
      }

      /* any other custom styles */
    </style>
    <script>
      // Hardcoded scene size for JS
      const SCENE_WIDTH = 3000
      const SCENE_HEIGHT = 800

      // Elements to position with (x, y) grid coords
      const initialPositions = {
        "#you": [
          {"x":2,"y":12},
        ],
        ".tree": [
          {"x":17,"y":7},
        ],
        ".wave": [
        ],
        ".star": [
          {"x":30,"y":3},
          {"x":33,"y":5},
        ],
        ".shell": [
          {"x":7,"y":11},
        ],
        "#finale": [
          {"x":41,"y":4,"center":false},
        ],
        "#next": [
          {"x":43,"y":15, center:false},
        ],
      }

      // String array of storyline
      const directions = [
        "Oh! Look at that. The stranger has sent ahead their own messenger with the secret gift you sent them.",
        "The secrets match up, so it's safe to let them join you now.",
        "Joined messenger to messenger to messenger, with the help of your fellow travelers, connection is established now.",
        "The stranger is here to meet you.",
      ]

      // Params are point: {x, y}, activation: () => {}, options?: { height, width, center }
      const activeAreasToCreate = [
        {
          point: initialPositions[".shell"][0],
          activation: () => displayOneByOne(stringList(directions[0])),
        },
        {
          point: initialPositions[".tree"][0],
          activation: () => {
            displayOneByOne(stringList(directions[1]))
            setUpMelody()
          },
        },
        {
          point: initialPositions[".star"][0],
          activation: () => displayOneByOne(stringList(directions[2])),
        },
        {
          point: initialPositions[".star"][1],
          activation: () => displayOneByOne(stringList(directions[3]), { after: displayFinale }),
        },
      ]

      // Game state
      const state = {
        boundaries: [],
        obstacles: [],
        activeArea: null,
        activeAreas: [],
      }

      function displayFinale() {
        const finale = document.getElementById("finale")
        // TODO: This might mean avatar is out of view now!
        // Also this is kind of fast, so I wonder if moving both
        // the scroll and the avatar at the same time might be nice?
        if (finale) {
          finale.scrollIntoView({ behavior: "smooth", inline: "center" })
        }
        showOrHideSelector("#finale", true)
        setTimeout(() => displayNextNode(initialPositions["#next"][0], "./gratitude.html"), 1000)
      }

      
      function updateLandscapeForLocation() {
        // Based on the rendezvous location, maybe change some styles?
        // case "overlook":
        //   return "./seeking-rendezvous.html?at=overlook"
        // case "open-field":
        //   return "./seeking-rendezvous.html?at=open-field"
        // case "river-edge":
        //   return "./seeking-rendezvous.html?at=river-edge"
      }

      document.addEventListener("DOMContentLoaded", () => {
         // Position elements on grid based on their pre-defined locations
        for (const selector of Object.keys(initialPositions)) {
          const positions = initialPositions[selector]
          positionOnGridBySelector(selector, positions)
        }

        // Set up sounds
        const audio = setUpMainAudio()

        // Add boundary of the page to boundary list
        const sceneBoundary = {
          startX: 0,
          startY: 0,
          endX: pixelsToGrid(SCENE_WIDTH),
          endY: pixelsToGrid(SCENE_HEIGHT),
        }
        state.boundaries.push(sceneBoundary)

        // Get the tagged obstacles and record their grid positions
        const obstacles = document.querySelectorAll('[data-obstacle]')
        obstacles.forEach((o) => {
          const { scrollX, scrollY } = window
          const { top, left, width, height } = o.getBoundingClientRect()
          const position = { startX: pixelsToGrid(scrollX + left), startY: pixelsToGrid(scrollY + top) }
          if (width > GRID_SIZE_PX) {
            const widthExceedingCell = width - GRID_SIZE_PX
            position.endX = pixelsToGrid(scrollX + left + widthExceedingCell)
          }

          if (height > GRID_SIZE_PX) {
            const heightExceedingCell = height - GRID_SIZE_PX
            position.endY = pixelsToGrid(scrollY + top + heightExceedingCell)
          }
          state.obstacles.push(position)
        })

        // Create any pre-defined active areas and add them
        // to the global state
        if (activeAreasToCreate && Array.isArray(activeAreasToCreate)) {
          activeAreasToCreate.forEach(area => {
            state.activeAreas.push(
              createActiveArea(area.point, area.activation, area.options)
            )
          })
        }

        // Move the avatar based on arrow presses
        document.addEventListener("keydown", onKeyDown)
      })
    </script>
  </head>
  <body>
    <main>
      <p id="direction" class="hidden"></p>
      <figure id="you" class="cell center">you</figure>

      <!-- shells -->
      <figure class="shell cell center" data-obstacle data-draggable>shell</figure>


      <!-- trees -->
      <figure class="tree cell center" data-obstacle data-draggable>tree</figure>


      <!-- stars -->
      <figure class="star cell center" data-obstacle data-draggable>star</figure>
      <figure class="star cell center" data-obstacle data-draggable>star</figure>

      <section id="finale" class="fade hidden-with-fade" data-obstacle data-draggable>
        <p>
          You have crossed an ocean for a stranger who has offered you connection.
        </p>
      </section>


      <!-- <section id="ocean" class="left"></section> -->
      <!-- <section id="island" class="left">island</section> -->
      <!-- <figure class="tree cell center" data-obstacle data-draggable></figure> -->
      <!-- <figure class="wave cell center"></figure> -->
      <a id="next" class="center two-cell-h hidden">thank you</a>
    </main>
    <!-- Controls for game -->
    <section role="toolbar" class="controls">
      <div>
        <button class="move-direction" onclick="onArrowButtonClick('up')">^</button>
        <button class="move-direction rotate-270" onclick="onArrowButtonClick('left')">^</button>
        <button class="move-direction rotate-90" onclick="onArrowButtonClick('right')">^</button>
        <button class="move-direction rotate-180" onclick="onArrowButtonClick('down')">^</button>
      </div>
      <button class="toggle" onclick="toggleGrid()">toggle grid</button>
      <button class="toggle" onclick="alert('not implemented yet sorry')">hide controls</button>
      <!-- <button class="toggle" onclick="printPositions()">print (dev)</button> -->
    </section>
    <div class="veil disappear" aria-hidden></div>
    <!-- TODO: Remove after dev is complete -->
    <!-- <script src="./draggable.js" defer></script> -->
  </body>
</html>