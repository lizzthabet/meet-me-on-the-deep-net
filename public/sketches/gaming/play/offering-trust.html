<!DOCTYPE html>
<html lang="en" class="grid">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>an offering of trust</title>
    <link rel="stylesheet" type="text/css" href="./styles_shared.css" />
    <link rel="stylesheet" type="text/css" href="./styles_website.css" />
    <script src="./gameplay.js" defer></script>
    <style>
      body {
        border: 1px dotted yellow;
        /* hardcoded page size */
        height: 800px;
        width: 3000px;
        /* This is needed to extend the ocean + island
        far offscreen */
        overflow: hidden;
      }

      #island {
        border-left: none;
        height: 500px;
        width: 2250px;
      }

      #ocean {
        background-color: blue;
        border-radius: 0 25px 25px 0;
        color: white;
        height: 600px;
        width: 2300px;
      }

      #trust-guide {
        font-size: 1.25rem;
        font-style: italic;
        text-align: center;
        width: 250px;
      }

      #signature {
        width: 300px;
      }

      .signature-info {
        display: block;
        font-style: italic;
        font-size: 0.95rem;
        margin: 10px 0;
      }

      #signature-write {
        font-size: 1rem;
        width: 100%;
      }

      .signature-sign {
        display: inline-block;
      }
    </style>
    <script>
      // Hardcoded scene size for JS
      const SCENE_WIDTH = 3000
      const SCENE_HEIGHT = 800

      // Elements to position with (x, y) grid coords
      const initialPositions = {
        "#you": [{ x: 2, y: 6 }],
        ".tree": [
          { x: 1, y: 5 },
          { x: 3, y: 12 },
          { x: 4, y: 10 },
          { x: 4, y: 11 },
          { x: 5, y: 10 }, // active
          { x: 6, y: 10 },
          { x: 6, y: 7 },
          { x: 10, y:12 }, // active
        ],
        // TODO: Add some waves pls
        ".wave": [],
        ".intro": [
          { x: 17, y: 6 },
          { x: 15, y: 10 },
          { x: 17, y: 14 },
          { x: 21, y: 6 },
          { x: 23, y: 10 },
          { x: 21, y: 14 },
        ],
        ".pen": [{x: 27, y: 8}], // active
        "#trust-guide": [{x: 17, y: 9, center: false}],
        "#island": [{ x: 0, y: 5, center: false }],
        ".island": [
          {x: 45, y: 10, center: false},
          {x: 43, y: 12, center: false},
          {x: 45, y: 12}, // duplicate, oops
        ],
        "#dock": [
          {x: 45, y: 12}, // will be active
        ],
        "#ocean": [{ x: 0, y: 4, center: false }],
        "#signature": [{x: 32, y: 9, center: false }],
        "#next": [{ x: 45, y: 7 }], // will be active
      }

      // String array of storyline
      const directions = [
        "Back on your island, you must find three travelers you trust to act as introduction points to you and the outside world.",
        "These three connections are the only contacts you'll trust. Got it?",
        "Next, you pick a unique hard-to-forge signature that will identify you in place of your name or where you live.",
        "It's time to release these signed introduction points for others to find.",
        // TODO: Maybe animate a bird flying in + off the screen?
        "And now, you wait."
      ]

      // Params are point: {x, y}, activation: () => {}, options?: { height, width, center }
      const activeAreasToCreate = [
        {
          point: initialPositions[".tree"][4],
          activation: () => displayOneByOne(stringList(directions[0]))
        },
        { 
          point: initialPositions[".tree"][7],
          activation: () => displayOneByOne(stringList(directions[1])),
        },
        {
          point: initialPositions[".intro"][0],
          activation: () => activateCheckbox(1),
        },
        {
          point: initialPositions[".intro"][1],
          activation: () => activateCheckbox(2),
        },
        {
          point: initialPositions[".intro"][2],
          activation: () => activateCheckbox(3),
        },
        {
          point: initialPositions[".intro"][3],
          activation: () => activateCheckbox(4),
        },
        {
          point: initialPositions[".intro"][4],
          activation: () => activateCheckbox(5),
        },
        {
          point: initialPositions[".intro"][5],
          activation: () => activateCheckbox(6),
        },
        { 
          point: initialPositions[".pen"][0],
          activation: () => displayOneByOne(
            stringList(directions[2]),
            { after: displayUniqueSignature }
          ),
        },
        { 
          point: initialPositions["#dock"][0],
          activation: () => displayOneByOne(
            stringList(directions[4]),
            { after: displayNextNode(initialPositions["#next"][0], "offering-rendezvous.html") }
          ),
        },
      ]

      // Game state
      const state = {
        boundaries: [],
        obstacles: [],
        activeArea: null,
        activeAreas: []
      }

      function updateTrustGuide() {
        const trusted = document.querySelectorAll("input:checked")
        const guide = document.getElementById("trust-guide")
        // TODO: It'd be nice to add / remove the pen activation + obstacle areas
        if (trusted.length === 3) {
          showOrHideSelector(".pen", true)
        } else {
          showOrHideSelector(".pen", false)
        }

        if (guide) {
          guide.innerText = `You have trusted ${trusted.length} out of 3 contacts that you need.`
          showOrHideSelector("#trust-guide", true)
        }
      }

      function activateCheckbox(number) {
        const cb = document.getElementById(`intro-${number}`)
        if (cb) {
          cb.checked = !cb.checked
          updateTrustGuide()
        }
      }

      function displayUniqueSignature() {
        // TODO: It'd be nice to add active areas and obstacles
        // for the input and buttons, so you don't need mouse
        // interactions and can't walk over them
        // TODO: At least treat the button like it's own active cell with positioning!
        // that triggers when you get near to it
        showOrHideSelector("#signature")
      }

      function displayNextDirection() {
        displayOneByOne(
          stringList(directions[3]),
          { after: () => {
            showOrHideSelector("#dock")
          }}
        )
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Position elements on grid based on their pre-defined locations
        for (const selector of Object.keys(initialPositions)) {
          const positions = initialPositions[selector]
          positionOnGridBySelector(selector, positions)
        }

        // Add boundary of the page to boundary list
        const sceneBoundary = {
          startX: 0,
          startY: 0,
          endX: pixelsToGrid(2250), // End a little early so you can't go off the island
          endY: pixelsToGrid(SCENE_HEIGHT),
        }
        state.boundaries.push(sceneBoundary)

        // Get the tagged obstacles and record their grid positions
        const obstacles = document.querySelectorAll('[data-obstacle]')
        obstacles.forEach((o) => {
          const { scrollX, scrollY } = window
          const { top, left, width, height } = o.getBoundingClientRect()
          const position = { startX: pixelsToGrid(scrollX + left), startY: pixelsToGrid(scrollY + top) }
          if (width > GRID_SIZE_PX) {
            const widthExceedingCell = width - GRID_SIZE_PX
            position.endX = pixelsToGrid(scrollX + left + widthExceedingCell)
          }

          if (height > GRID_SIZE_PX) {
            const heightExceedingCell = height - GRID_SIZE_PX
            position.endY = pixelsToGrid(scrollY + top + heightExceedingCell)
          }
          state.obstacles.push(position)
        })

        // Create any pre-defined active areas and add them
        // to the global state
        if (activeAreasToCreate && Array.isArray(activeAreasToCreate)) {
          activeAreasToCreate.forEach(area => {
            state.activeAreas.push(
              createActiveArea(area.point, area.activation, area.options)
            )
          })
        }

        // Move the avatar based on arrow presses
        document.addEventListener("keydown", onKeyDown)
      })
    </script>
  </head>
  <body>
    <main>
      <p id="direction" class="hidden"></p>
      <figure id="you" class="cell center">you</figure>
      <section id="ocean"></section>
      <section id="island"></section>
      <figure class="tree cell center" data-obstacle></figure>
      <figure class="tree cell center" data-obstacle></figure>
      <figure class="tree cell center" data-obstacle></figure>
      <figure class="tree cell center" data-obstacle></figure>
      <figure class="tree cell center" data-obstacle>tree</figure>
      <figure class="tree cell center" data-obstacle></figure>
      <figure class="tree cell center" data-obstacle></figure>
      <figure class="tree cell center" data-obstacle>tree</figure>

      <!-- Introduction points of trust -->
      <figure class="intro cell center" data-obstacle>
        <input id="intro-1" type="checkbox" />
        <label for="intro-1">trust</label>
      </figure>
      <figure class="intro cell center" data-obstacle data-draggable>
        <input id="intro-2" type="checkbox" />
        <label for="intro-2">trust</label>
      </figure>
      <figure class="intro cell center" data-obstacle data-draggable>
        <input id="intro-3" type="checkbox" />
        <label for="intro-3">trust</label>
      </figure>
      <figure class="intro cell center" data-obstacle data-draggable>
        <input id="intro-4" type="checkbox" />
        <label for="intro-4">trust</label>
      </figure>
      <figure class="intro cell center" data-obstacle data-draggable>
        <input id="intro-5" type="checkbox" />
        <label for="intro-5">trust</label>
      </figure>
      <figure class="intro cell center" data-obstacle data-draggable>
        <input id="intro-6" type="checkbox" />
        <label for="intro-6">trust</label>
      </figure>
      <p id="trust-guide" class="fade hidden-with-fade" data-draggable></p>

      <!-- pen -->
      <figure class="pen cell center fade hidden-with-fade" data-obstacle data-draggable>pen</figure>
      <figure id="signature" class="fade hidden-with-fade" data-draggable>
        <input id="signature-write" type="text" required minlength="5"/>
        <label for="signature-write" class="signature-info">Enter an unique phrase, like your least favorite color and the name of your first imaginary friend, or perhaps the first place you'd go if you had a bad day.</label>
        <button class="signature-sign cell" type="submit" onclick="displayNextDirection()">sign</button>
      </figure>

      <!-- dock -->
      <figure class="island two-cell-v center" data-draggable></figure>
      <figure class="island two-cell-h center" data-draggable></figure>
      <figure id="dock" class="island cell center" data-obstacle data-draggable>dock</figure>

      <!-- next -->
      <a id="next" class="next-backlit hidden center cell circle">next</a>
    </main>
    <!-- Controls for game -->
    <section role="toolbar" class="controls">
      <div>
        <button class="move-direction" onclick="onArrowButtonClick('up')">^</button>
        <button class="move-direction rotate-270" onclick="onArrowButtonClick('left')">^</button>
        <button class="move-direction rotate-90" onclick="onArrowButtonClick('right')">^</button>
        <button class="move-direction rotate-180" onclick="onArrowButtonClick('down')">^</button>
      </div>
      <button class="toggle" onclick="toggleGrid()">toggle grid</button>
      <button class="toggle" onclick="alert('not implemented yet sorry')">hide controls</button>
      <!-- <button class="toggle" onclick="printPositions()">print (dev)</button> -->
    </section>
    <div class="veil disappear" aria-hidden></div>
    <!-- TODO: Remove after dev is complete -->
    <!-- <script src="../draggable.js" defer></script> -->
  </body>
</html>